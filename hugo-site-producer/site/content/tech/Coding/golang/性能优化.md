---
title: "æ€§èƒ½ä¼˜åŒ–"
date: 2026-01-26T15:44:49+08:00
draft: false
tags: ['code', 'golang', 'AIGC', 'learning']
toc: true
showTableOfContents: true
---

## ğŸ“Š **æ€§èƒ½ä¼˜åŒ–åˆ†ç±»æ€»è§ˆ**

```
â”Œâ”€ ä»£ç å±‚é¢ä¼˜åŒ–
â”‚  â”œâ”€ å†…å­˜ä¼˜åŒ–
â”‚  â”œâ”€ å¹¶å‘ä¼˜åŒ–  
â”‚  â”œâ”€ ç®—æ³•ä¼˜åŒ–
â”‚  â””â”€ ç¼–è¯‘å™¨ä¼˜åŒ–
â”‚
â”œâ”€ è¿è¡Œæ—¶ä¼˜åŒ–
â”‚  â”œâ”€ GC ä¼˜åŒ–
â”‚  â”œâ”€ è°ƒåº¦ä¼˜åŒ–
â”‚  â””â”€ å†…å­˜ç®¡ç†
â”‚
â”œâ”€ I/O ä¼˜åŒ–
â”‚  â”œâ”€ ç½‘ç»œä¼˜åŒ–
â”‚  â”œâ”€ æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–
â”‚  â””â”€ æ•°æ®åº“ä¼˜åŒ–
â”‚
â””â”€ ç³»ç»Ÿå±‚é¢ä¼˜åŒ–
   â”œâ”€ éƒ¨ç½²ä¼˜åŒ–
   â”œâ”€ ç›‘æ§ä¼˜åŒ–
   â””â”€ ç¡¬ä»¶ä¼˜åŒ–
```

## ğŸ”§ **è¯¦ç»†çš„æ€§èƒ½ä¼˜åŒ–æ€è·¯**

### ä¸€ã€å†…å­˜ç®¡ç†ä¼˜åŒ–ï¼ˆé‡ç‚¹ï¼ï¼‰

#### 1. **å‡å°‘å†…å­˜åˆ†é…**
```go
// âŒ é¿å…åœ¨å¾ªç¯ä¸­é¢‘ç¹åˆ†é…
for i := 0; i < 1000; i++ {
    data := make([]byte, 1024)  // æ¯æ¬¡å¾ªç¯éƒ½åˆ†é…
    // ä½¿ç”¨ data...
}

// âœ… é¢„åˆ†é…æˆ–å¤ç”¨
buffer := make([]byte, 1024)
for i := 0; i < 1000; i++ {
    // å¤ç”¨ buffer
}
```

#### 2. **ä½¿ç”¨å¯¹è±¡æ±  sync.Pool**
```go
var bufferPool = sync.Pool{
    New: func() interface{} {
        return bytes.NewBuffer(make([]byte, 0, 1024))
    },
}

func getBuffer() *bytes.Buffer {
    return bufferPool.Get().(*bytes.Buffer)
}

func putBuffer(buf *bytes.Buffer) {
    buf.Reset()
    bufferPool.Put(buf)
}
```

#### 3. **é¿å…å†…å­˜é€ƒé€¸**
```go
// âŒ å¯èƒ½é€ƒé€¸åˆ°å †
func newUser() *User {
    return &User{Name: "John"}  // é€ƒé€¸åˆ°å †
}

// âœ… å¦‚æœå¯èƒ½ï¼Œè®©è°ƒç”¨æ–¹åˆ†é…
func fillUser(u *User) {
    u.Name = "John"
}
```

#### 4. **ä½¿ç”¨æ ˆåˆ†é…**
```go
// å°å¯¹è±¡å°½é‡åœ¨æ ˆä¸Šåˆ†é…
type Small struct {
    a, b int32
}

// ç¼–è¯‘å™¨ä¼šä¼˜å…ˆåœ¨æ ˆä¸Šåˆ†é…
func process() {
    var s Small  // æ ˆåˆ†é…
    // ...
}
```

### äºŒã€å¹¶å‘ä¸å¹¶è¡Œä¼˜åŒ–

#### 1. **æ§åˆ¶ Goroutine æ•°é‡**
```go
// âŒ æ— é™åˆ¶åˆ›å»º goroutine
for _, task := range tasks {
    go process(task)  // å¯èƒ½åˆ›å»ºå¤ªå¤š goroutine
}

// âœ… ä½¿ç”¨ worker pool
type WorkerPool struct {
    workers int
    tasks   chan Task
}

func (wp *WorkerPool) Start() {
    for i := 0; i < wp.workers; i++ {
        go wp.worker()
    }
}
```

#### 2. **å‡å°‘é”ç«äº‰**
```go
// âŒ ç²—ç²’åº¦é”
var mu sync.Mutex
var data map[string]int

func update(key string, value int) {
    mu.Lock()
    data[key] = value
    mu.Unlock()
}

// âœ… ç»†ç²’åº¦é”æˆ–åˆ†ç‰‡é”
type ShardedMap struct {
    shards []map[string]int
    locks  []sync.RWMutex
}

func (sm *ShardedMap) getShard(key string) int {
    return int(fnv32(key)) % len(sm.shards)
}
```

#### 3. **ä½¿ç”¨ atomic æ“ä½œ**
```go
// âŒ ä½¿ç”¨é”ä¿æŠ¤è®¡æ•°å™¨
var count int
var mu sync.Mutex

func increment() {
    mu.Lock()
    count++
    mu.Unlock()
}

// âœ… ä½¿ç”¨ atomic
var count int64

func increment() {
    atomic.AddInt64(&count, 1)
}
```

#### 4. **åˆ©ç”¨ CPU ç¼“å­˜è¡Œ**
```go
// âŒ ä¼ªå…±äº«é—®é¢˜
type Data struct {
    a int64
    b int64  // å¯èƒ½åœ¨åŒä¸€ç¼“å­˜è¡Œ
}

// âœ… ç¼“å­˜è¡Œå¯¹é½
type Data struct {
    a int64
    _ [56]byte  // å¡«å……ï¼Œç¡®ä¿åœ¨ä¸åŒç¼“å­˜è¡Œ
    b int64
}
```

### ä¸‰ã€æ•°æ®ç»“æ„ä¸ç®—æ³•ä¼˜åŒ–

#### 1. **é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„**
```go
// æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©
- æŸ¥æ‰¾é¢‘ç¹ â†’ map
- æœ‰åºæ•°æ® â†’ slice + äºŒåˆ†æŸ¥æ‰¾
- é¢‘ç¹æ’å…¥åˆ é™¤ â†’ linked list
- å”¯ä¸€æ€§æ£€æŸ¥ â†’ map æˆ– bitset
```

#### 2. **é¢„åˆ†é…å®¹é‡**
```go
// âŒ åŠ¨æ€æ‰©å®¹
var users []User
for i := 0; i < 10000; i++ {
    users = append(users, User{})  // å¤šæ¬¡æ‰©å®¹
}

// âœ… é¢„åˆ†é…
users := make([]User, 0, 10000)
for i := 0; i < 10000; i++ {
    users = append(users, User{})
}
```

#### 3. **ä½¿ç”¨æ›´å¿«çš„ç®—æ³•**
```go
// âŒ O(nÂ²)
for i := 0; i < n; i++ {
    for j := 0; j < n; j++ {
        // å¤„ç†
    }
}

// âœ… O(n log n) æˆ– O(n)
sort.Slice(data, func(i, j int) bool {
    return data[i] < data[j]
})
```

#### 4. **åˆ©ç”¨ä½è¿ç®—**
```go
// âŒ ä¹˜é™¤è¿ç®—
x := a * 2
y := b / 2

// âœ… ä½è¿ç®—
x := a << 1  // ä¹˜ä»¥2
y := b >> 1  // é™¤ä»¥2
```

### å››ã€I/O æ€§èƒ½ä¼˜åŒ–

#### 1. **æ‰¹é‡æ“ä½œ**
```go
// âŒ å•æ¡æ“ä½œ
for _, user := range users {
    db.Insert(user)
}

// âœ… æ‰¹é‡æ“ä½œ
db.BulkInsert(users)
```

#### 2. **ç¼“å†² I/O**
```go
// âŒ æ— ç¼“å†²
file, _ := os.Open("data.txt")
buf := make([]byte, 1)
for {
    n, err := file.Read(buf)
    // ...
}

// âœ… å¸¦ç¼“å†²
reader := bufio.NewReader(file)
for {
    line, err := reader.ReadString('\n')
    // ...
}
```

#### 3. **è¿æ¥å¤ç”¨**
```go
// âŒ æ¯æ¬¡åˆ›å»ºè¿æ¥
func query() {
    db, _ := sql.Open(...)
    defer db.Close()
    // ...
}

// âœ… è¿æ¥æ± 
var db *sql.DB

func init() {
    db, _ = sql.Open(...)
    db.SetMaxOpenConns(100)
    db.SetMaxIdleConns(10)
}
```

#### 4. **é›¶æ‹·è´æŠ€æœ¯**
```go
// âŒ æ•°æ®å¤åˆ¶
func process(data []byte) []byte {
    result := make([]byte, len(data))
    copy(result, data)
    // å¤„ç†
    return result
}

// âœ… é¿å…å¤åˆ¶
func processInPlace(data []byte) {
    // åŸåœ°å¤„ç†
    for i := range data {
        data[i] = data[i] + 1
    }
}
```

### äº”ã€ç¼–è¯‘å™¨ä¸è¿è¡Œæ—¶ä¼˜åŒ–

#### 1. **å†…è”ä¼˜åŒ–**
```go
// ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å†…è”å°å‡½æ•°
// æ ‡è®°ä¸º //go:noinline å¯ä»¥é˜»æ­¢å†…è”
func smallFunction(a, b int) int {
    return a + b  // å¯èƒ½è¢«å†…è”
}

//go:noinline
func largeFunction() {
    // ä¸ä¼šè¢«å†…è”
}
```

#### 2. **é€ƒé€¸åˆ†æä¼˜åŒ–**
```go
// æŸ¥çœ‹é€ƒé€¸åˆ†æ
go build -gcflags="-m -l"

// è¾“å‡ºä¼šæ˜¾ç¤ºå“ªäº›å˜é‡é€ƒé€¸åˆ°å †
```

#### 3. **ç¼–è¯‘å™¨æŒ‡ä»¤**
```go
// è¾¹ç•Œæ£€æŸ¥æ¶ˆé™¤
func sum(arr []int) int {
    s := 0
    for i := range arr {
        s += arr[i]  // ç¼–è¯‘å™¨å¯èƒ½æ¶ˆé™¤è¾¹ç•Œæ£€æŸ¥
    }
    return s
}

// ç¼–è¯‘æ—¶ç¦ç”¨è¾¹ç•Œæ£€æŸ¥
// go build -gcflags="-B"
```

#### 4. **ä½¿ç”¨ PGOï¼ˆProfile-Guided Optimizationï¼‰**
```go
// 1. æ”¶é›†æ€§èƒ½æ•°æ®
go test -cpuprofile=cpu.prof -bench=.

// 2. ä½¿ç”¨ PGO ç¼–è¯‘
go build -pgo=cpu.prof
```

### å…­ã€å­—ç¬¦ä¸²ä¸å­—èŠ‚å¤„ç†ä¼˜åŒ–

#### 1. **strings.Builder**
```go
// âŒ å­—ç¬¦ä¸²æ‹¼æ¥
var result string
for i := 0; i < 1000; i++ {
    result += strconv.Itoa(i)
}

// âœ… ä½¿ç”¨ strings.Builder
var builder strings.Builder
for i := 0; i < 1000; i++ {
    builder.WriteString(strconv.Itoa(i))
}
result := builder.String()
```

#### 2. **é¿å… []byte ä¸ string è½¬æ¢**
```go
// âŒ é¢‘ç¹è½¬æ¢
func process(s string) {
    b := []byte(s)  // åˆ†é…æ–°å†…å­˜
    // å¤„ç† b
    s2 := string(b) // å†æ¬¡åˆ†é…
}

// âœ… ç»Ÿä¸€ä½¿ç”¨ []byte
func process(b []byte) []byte {
    // åŸåœ°å¤„ç†
    return b
}
```

#### 3. **ä½¿ç”¨ bytes åŒ…ä»£æ›¿ strings åŒ…**
```go
// bytes åŒ…æ“ä½œ []byteï¼Œé¿å…è½¬æ¢
// âŒ
s := "hello"
s = strings.ToUpper(s)

// âœ…
b := []byte("hello")
b = bytes.ToUpper(b)
```

### ä¸ƒã€ç½‘ç»œä¸åè®®ä¼˜åŒ–

#### 1. **åè®®é€‰æ‹©**
```go
// æ ¹æ®åœºæ™¯é€‰æ‹©åè®®
- REST/HTTP/1.1 â†’ ç®€å•ï¼Œå…¼å®¹æ€§å¥½
- HTTP/2 â†’ å¤šè·¯å¤ç”¨ï¼Œå¤´éƒ¨å‹ç¼©
- gRPC â†’ é«˜æ€§èƒ½ï¼Œprotobuf ç¼–ç 
- WebSocket â†’ å®æ—¶åŒå‘é€šä¿¡
```

#### 2. **è¿æ¥å¤ç”¨ï¼ˆHTTP/2, HTTP/3ï¼‰**
```go
// é…ç½® HTTP å®¢æˆ·ç«¯
client := &http.Client{
    Transport: &http.Transport{
        MaxIdleConns:        100,
        MaxIdleConnsPerHost: 10,
        IdleConnTimeout:     90 * time.Second,
        // å¯ç”¨ HTTP/2
        ForceAttemptHTTP2: true,
    },
}
```

#### 3. **å‹ç¼©ä¸åºåˆ—åŒ–**
```go
// é€‰æ‹©åˆé€‚çš„åºåˆ—åŒ–æ ¼å¼
- JSON â†’ é€šç”¨ï¼Œå¯è¯»æ€§å¥½
- Protobuf â†’ é«˜æ•ˆï¼ŒäºŒè¿›åˆ¶
- MessagePack â†’ äºŒè¿›åˆ¶ JSON
- FlatBuffers â†’ é›¶æ‹·è´åºåˆ—åŒ–

// ä½¿ç”¨å‹ç¼©
import "compress/gzip"
```

### å…«ã€æ•°æ®åº“ä¼˜åŒ–

#### 1. **SQL ä¼˜åŒ–**
```go
// âŒ N+1 æŸ¥è¯¢
for _, user := range users {
    db.Query("SELECT * FROM orders WHERE user_id = ?", user.ID)
}

// âœ… JOIN æˆ–æ‰¹é‡æŸ¥è¯¢
db.Query(`
    SELECT u.*, o.* 
    FROM users u 
    LEFT JOIN orders o ON u.id = o.user_id
`)
```

#### 2. **ç´¢å¼•ä¼˜åŒ–**
```go
// æ·»åŠ åˆé€‚ç´¢å¼•
CREATE INDEX idx_user_email ON users(email);
CREATE INDEX idx_order_user_date ON orders(user_id, created_at);
```

#### 3. **è¿æ¥æ± é…ç½®**
```go
db.SetMaxOpenConns(100)     // æœ€å¤§è¿æ¥æ•°
db.SetMaxIdleConns(25)      // æœ€å¤§ç©ºé—²è¿æ¥æ•°
db.SetConnMaxLifetime(5 * time.Minute)  // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
```

### ä¹ã€ç›‘æ§ä¸åˆ†æå·¥å…·

#### 1. **ä½¿ç”¨ pprof**
```go
import _ "net/http/pprof"

go func() {
    http.ListenAndServe(":6060", nil)
}()

// æ”¶é›†æ•°æ®
go tool pprof http://localhost:6060/debug/pprof/profile
go tool pprof http://localhost:6060/debug/pprof/heap
```

#### 2. **ä½¿ç”¨ trace**
```go
import "runtime/trace"

trace.Start(w)
defer trace.Stop(w)

// åˆ†æ
go tool trace trace.out
```

#### 3. **ä½¿ç”¨ expvar**
```go
import "expvar"

var (
    requestCount = expvar.NewInt("request_count")
    avgLatency   = expvar.NewFloat("avg_latency_ms")
)

func handler(w http.ResponseWriter, r *http.Request) {
    start := time.Now()
    // å¤„ç†è¯·æ±‚
    latency := time.Since(start).Milliseconds()
    requestCount.Add(1)
    // æ›´æ–°å¹³å‡å»¶è¿Ÿ...
}
```

### åã€éƒ¨ç½²ä¸ç³»ç»Ÿä¼˜åŒ–

#### 1. **å®¹å™¨ä¼˜åŒ–**
```dockerfile
# å¤šé˜¶æ®µæ„å»º
FROM golang:1.21 AS builder
WORKDIR /app
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .

FROM alpine:latest
COPY --from=builder /app/app .
CMD ["./app"]
```

#### 2. **æ“ä½œç³»ç»Ÿä¼˜åŒ–**
```bash
# è°ƒæ•´ç³»ç»Ÿå‚æ•°
sysctl -w net.core.somaxconn=65535
sysctl -w net.ipv4.tcp_tw_reuse=1
sysctl -w net.ipv4.ip_local_port_range="1024 65000"
```

#### 3. **CPU äº²å’Œæ€§**
```go
import "runtime"

// è®¾ç½® GOMAXPROCS
runtime.GOMAXPROCS(runtime.NumCPU())

// ä½¿ç”¨ taskset ç»‘å®š CPU
// taskset -c 0-3 ./app
```

## ğŸ“ˆ **æ€§èƒ½ä¼˜åŒ–ä¼˜å…ˆçº§**

### ä¼˜å…ˆçº§ 1ï¼šå½±å“æœ€å¤§çš„ä¼˜åŒ–
1. **ç®—æ³•ä¼˜åŒ–** - æ”¹å˜å¤æ‚åº¦ï¼ˆO(nÂ²) â†’ O(n log n)ï¼‰
2. **å‡å°‘ä¸å¿…è¦çš„æ“ä½œ** - é¿å…é‡å¤è®¡ç®—
3. **æ‰¹é‡å¤„ç†** - å‡å°‘ I/O æ¬¡æ•°

### ä¼˜å…ˆçº§ 2ï¼šæ˜¾è‘—çš„ä¼˜åŒ–
1. **å†…å­˜åˆ†é…ä¼˜åŒ–** - å‡å°‘ GC å‹åŠ›
2. **å¹¶å‘ä¼˜åŒ–** - åˆç†ä½¿ç”¨ goroutine å’Œé”
3. **æ•°æ®ç»“æ„ä¼˜åŒ–** - é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„

### ä¼˜å…ˆçº§ 3ï¼šå¾®ä¼˜åŒ–
1. **ç¼–è¯‘å™¨ä¼˜åŒ–** - å†…è”ã€é€ƒé€¸åˆ†æ
2. **CPU ç¼“å­˜ä¼˜åŒ–** - ç¼“å­˜è¡Œå¯¹é½
3. **æŒ‡ä»¤çº§ä¼˜åŒ–** - ä½è¿ç®—ç­‰

## ğŸ¯ **æ€§èƒ½ä¼˜åŒ–é»„é‡‘æ³•åˆ™**

1. **æµ‹é‡ç¬¬ä¸€** - ä½¿ç”¨ pprof ç­‰å·¥å…·æ‰¾åˆ°ç“¶é¢ˆ
2. **20/80 æ³•åˆ™** - ä¼˜åŒ– 20% çš„ä»£ç è·å¾— 80% çš„æ”¶ç›Š
3. **æ¸è¿›ä¼˜åŒ–** - å…ˆåšç®€å•æœ‰æ•ˆçš„å¤§ä¼˜åŒ–ï¼Œå†åšå¤æ‚çš„å°ä¼˜åŒ–
4. **ä¿æŒå¯è¯»æ€§** - ä¸è¦ä¸ºäº†æ€§èƒ½ç‰ºç‰²ä»£ç å¯ç»´æŠ¤æ€§
5. **è€ƒè™‘ ROI** - è¯„ä¼°ä¼˜åŒ–æŠ•å…¥ä¸æ”¶ç›Šæ¯”

## ğŸ“š **å®ç”¨æ£€æŸ¥æ¸…å•**

```go
// æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•
â–¡ 1. æ˜¯å¦æœ‰ä¸å¿…è¦çš„å†…å­˜åˆ†é…ï¼Ÿ
â–¡ 2. æ˜¯å¦å¯ä»¥å¤ç”¨å¯¹è±¡ï¼ˆsync.Poolï¼‰ï¼Ÿ
â–¡ 3. æ˜¯å¦æœ‰é”ç«äº‰ï¼Ÿ
â–¡ 4. æ˜¯å¦ä½¿ç”¨äº†åˆé€‚çš„å¹¶å‘æ¨¡å¼ï¼Ÿ
â–¡ 5. ç®—æ³•å¤æ‚åº¦æ˜¯å¦å¯ä»¥é™ä½ï¼Ÿ
â–¡ 6. æ˜¯å¦æœ‰é‡å¤è®¡ç®—ï¼Ÿ
â–¡ 7. I/O æ“ä½œæ˜¯å¦å¯ä»¥æ‰¹é‡å¤„ç†ï¼Ÿ
â–¡ 8. æ˜¯å¦ä½¿ç”¨äº†ç¼“å†² I/Oï¼Ÿ
â–¡ 9. æ•°æ®åº“æŸ¥è¯¢æ˜¯å¦æœ‰ç´¢å¼•ï¼Ÿ
â–¡ 10. æ˜¯å¦å¯ç”¨äº†è¿æ¥æ± ï¼Ÿ
â–¡ 11. æ˜¯å¦é¿å…äº†ä¸å¿…è¦çš„ []byte/string è½¬æ¢ï¼Ÿ
â–¡ 12. æ˜¯å¦ä½¿ç”¨äº†åˆé€‚çš„åºåˆ—åŒ–æ ¼å¼ï¼Ÿ
â–¡ 13. æ˜¯å¦ç›‘æ§äº†å…³é”®æŒ‡æ ‡ï¼Ÿ
```

è®°ä½ï¼š**è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æº**ã€‚åœ¨ä¼˜åŒ–ä¹‹å‰ï¼Œä¸€å®šè¦é€šè¿‡ profiling ç¡®å®šçœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆï¼Œæœ‰é’ˆå¯¹æ€§çš„è¿›è¡Œä¼˜åŒ–ã€‚