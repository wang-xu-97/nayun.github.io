---
title: "自定义类"
date: 2026-02-28T16:48:27+08:00
draft: false
tags: ["技"]
toc: true
showTableOfContents: true
---

## 自定义飞书块类
```python
class block:
    '''一个block为一行

        :param content:
            str:{content:None}
            dict:{content:style}
        :param blocktype:
            2：文本 Block
            3：标题 1 Block
            4：标题 2 Block
            5：标题 3 Block
            6：标题 4 Block
            7：标题 5 Block
            8：标题 6 Block
            13：有序列表 Block
            27：image Block
            ...
            参考:https://open.feishu.cn/document/server-docs/docs/docs/docx-v1/document-block/create#1b8abd5d
        :param indent:
            首行缩进级别。仅支持对 Text 块进行修改，其余类型不生效。
            示例值："NoIndent"
            可选值有：
                NoIndent：无缩进
                OneLevelIndent：一级缩进

        :param align:
            对齐方式
            1：居左排版
            2：居中排版
            3：居右排版
            默认值：1

        :param background_color
            LightGrayBackground：浅灰色
            LightRedBackground：浅红色
            LightOrangeBackground：浅橙色
            LightYellowBackground：浅黄色
            LightGreenBackground：浅绿色
            LightBlueBackground：浅蓝色
            LightPurpleBackground：浅紫色
            PaleGrayBackground：中灰色
            DarkGrayBackground：灰色
            DarkRedBackground：中红色
            DarkOrangeBackground：中橙色
            DarkYellowBackground：中黄色
            DarkGreenBackground：中绿色
            DarkBlueBackground：中蓝色
            DarkPurpleBackground：中紫色
    '''
    class Content:
        '''
        Text Content自定义样式支持：
            bold
                示例值：true
                默认值：false

            italic
                示例值：true
                默认值：false

            strikethrough 删除线
                示例值：true
                默认值：false

            underline 下划线
                示例值：true
                默认值：false

            inline_code inline代码
                示例值：true
                默认值：false

            background_color 背景色
                可选值有：
                1：浅红色
                2：浅橙色
                3：浅黄色
                4：浅绿色
                5：浅蓝色
                6：浅紫色
                7：中灰色
                8：红色
                9：橙色
                10：黄色
                11：绿色
                12：蓝色
                13：紫色
                14：灰色
                15：浅灰色

            text_color 字体颜色
                可选值有：
                1：红色
                2：橙色
                3：黄色
                4：绿色
                5：蓝色

            link 链接
                url 超链接指向的 url (需要 url_encode)
                    示例值："https%3A%2F%2Fopen.feishu.cn%2F"
        '''
        def __init__(self, content) -> None:
            if isinstance(content, dict):
                self.contents = {
                    c:style
                    for c, style in content.items()
                }
            else:
                self.contents = {str(content):{}}
        
        def __iter__(self):
            return iter(self.contents.items())
        
        def __contains__(self, k):
            return k in self.contents

    def __init__(self, content, blocktype=2, indent='NoIndent', align=1, background_color=None) -> None:
        self.type = blocktype
        self.indent = indent
        self.align = align
        self.background_color = background_color
        self.content = None
        if blocktype != 27 and content!= None:
            self.content = self.Content(content)
    
    __doc__ = __doc__ + Content.__doc__

```

## 自定义飞书请求异常类
```python
class LarkException(Exception):
    def __init__(self, code=0, msg=None):
        self.code = code
        self.msg = msg

    def __str__(self) -> str:
        return "{}:{}".format(self.code, self.msg)

    __repr__ = __str__


def request(method, url, headers, payload=None, data=None, retry=6, timeout=None, rcode=0):
    e = None
    err_resp = None
    resp = {}
    while retry:
        try:
            response = requests.request(method, url, headers=headers, json=payload, data=data, timeout=timeout)
            try:
                resp = response.json()
            except:
                pass
            code = resp.get("code", None)
            if code == -1:
                code = resp.get("StatusCode", -1)
            if code == -1 and response.status_code != 200:
                response.raise_for_status()
            if code != None and code != rcode:
                raise LarkException(code=code, msg=resp.get("msg", ""))
            break
        except KeyboardInterrupt:
            print('\n停止')
            raise KeyboardInterrupt
        except:
            print(f'request retry {retry}...')
            e = traceback.format_exc()
            err_resp = resp
            retry -= 1
            time.sleep(0.1)
    else:
        raise requests.RequestException(str(e)+str(err_resp))
    
    return resp
```

## 自定义飞书client请求方法类
```python
class Client(object):
    APP_ID = ''
    APP_SECRET = ''
    LARK_HOST = 'https://open.feishu.cn/'

    def __init__(self):
        self._host = self.LARK_HOST
        self.token = self.get_tenant_access_token()

    def get_tenant_access_token(self):
        url = self._host + "/open-apis/auth/v3/app_access_token/internal/"
        headers = {'Content-Type': 'application/json; charset=utf-8'}
        payload = {'app_id': self.APP_ID, 'app_secret': self.APP_SECRET}
        resp = request("POST", url, headers, payload)
        return resp['tenant_access_token']

    ############################### DOCX API ######################################
    def createdocx(self, title, folder_token=None, access_token=None):
        '''
        :return:
            document id
        '''
        url = self._host + '/open-apis/docx/v1/documents'
        folder_token = '' if not folder_token else folder_token
        access_token = self.token if not access_token else access_token
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + access_token}
        payload = {"title": title, "folder_token": folder_token}
        resp = request("POST", url, headers, payload)
        return resp['data']['document']['document_id']

    def fetchblocks(self, document_id, block_id=None, access_token=None):
        url1 = self._host + f'/open-apis/docx/v1/documents/{document_id}/blocks'
        url2 = self._host + f"/open-apis/docx/v1/documents/{document_id}/blocks/{block_id}/children"
        url = url2 if block_id else url1
        access_token = self.token if not access_token else access_token
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + access_token}
        resp = request("GET", url, headers)
        return resp
    
    def creategrid(self, document_id:str, col:int, access_token=None) -> list:
        '''
        创建分栏块，col: 2 ~ 5
        :return:
            children block list
        '''
        if col < 2:
            return document_id
        url = f'{self._host}/open-apis/docx/v1/documents/{document_id}/blocks/{document_id}/children'
        access_token = self.token if not access_token else access_token
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + access_token}
        payload = {
            "index": -1,
            "children": [
                {
                    "block_type": 24,
                    "grid": {
                        "column_size": 5 if col > 5 else col,
                    }
                }
            ]
        }
        resp = request("POST", url, headers, payload)
        return resp['data']['children'][0]['children']

    def createblocks(self, document_id:str, blocks, block_id:str=None, insert_index:int=-1, access_token=None) -> list:
        '''
        创建文本块
        
        block_type支持：
            - text(2)
            - heading1~6(3~8)
            - 列表(无序:12，有序:13)
            - 代码块(14)
            - 引用(15)
            - 代办(17)

        :param blocks:
            block or block list
        :return:
            children block id list
        '''
        if not isinstance(blocks, list):
            blocks = [blocks]
        if not block_id:
            block_id = document_id
        url = self._host + f'/open-apis/docx/v1/documents/{document_id}/blocks/{block_id}/children'
        access_token = self.token if not access_token else access_token
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + access_token}
        blockmap = {2: "text", 3: "heading1", 4: "heading2", 5: "heading3", 6: "heading4", 7: "heading5", 8: "heading6"
                    , 12: "bullet", 13:"ordered", 14:"code", 15:"quote", 17:"todo", 27:"image"}
        payload = {
            "index": insert_index,
            "children": [
                {
                    "block_type": block.type,
                    blockmap[block.type]: {
                        "style":{
                            "indentation_level": block.indent,
                            "align":block.align,
                            "background_color":block.background_color,
                        } if block.type == 2 else {},
                        "elements": [
                            {
                                "text_run": {
                                    "content": content,
                                    "text_element_style": style
                                },
                            }
                            for content, style in block.content
                        ],
                    } if block.content else {}
                }
                for block in blocks
            ]
        }
        resp = request("POST", url, headers, payload)

        # 限制api请求频率
        time.sleep(0.1)
        childrenblocks = []
        if resp['code'] == 0:
            childrenblocks = [c['block_id'] for c in resp['data']['children']]
        return childrenblocks
    
    def createsheet(self, document_id:str, row:int, col:int, 
                   block_id:str=None, insert_index:int=-1, access_token=None) -> list:
        '''
        创建docx内置电子表格
        :param merge coord:
            合并坐标从下标1开始，比如第2行第2列到第3行第4列，start:(2, 2) end:(3, 4)
        :return:
            spreadsheet_token, sheet_id
        '''
        if row < 1 or col < 1:
            return None
        if not block_id:
            block_id = document_id
        url = f'{self._host}/open-apis/docx/v1/documents/{document_id}/blocks/{block_id}/children'
        access_token = self.token if not access_token else access_token
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + access_token}
        extra_row = 0 if row < 10 else (row - 9)
        extra_col = 0 if col < 10 else (col - 9)
        payload = {
            "index": insert_index,
            "children": [
                {
                    "block_type": 30,
                    "sheet": {
                        "row_size": 9 if extra_row else row,
                        "column_size": 9 if extra_col else col,
                    }
                }
            ]
        }
        resp = request("POST", url, headers, payload)
        if None != (code:=resp.get('code', None)):
            if code != 0: raise LarkException(resp['code'], resp['msg'])
        else: 
            print(resp)
            return None
        spreadsheet_token, sheet_id = resp['data']['children'][0]['sheet']['token'].split('_')
        url =  f'{self._host}/open-apis/sheets/v2/spreadsheets/{spreadsheet_token}/dimension_range'
        if extra_row:
            payload = {
                "dimension":{
                    "sheetId":sheet_id,
                    "majorDimension":'ROWS',
                    "length":extra_row,
                },
            }
            resp = request("POST", url, headers, payload)

        if extra_col:
            payload = {
                "dimension":{
                    "sheetId":sheet_id,
                    "majorDimension":'COLUMNS',
                    "length":extra_col,
                },
            }
            resp = request("POST", url, headers, payload)
    
        return spreadsheet_token, sheet_id
    
    def createtable(self, document_id:str, row:int, col:int, 
                   column_width:list=[],
                   merge_start_coord:tuple=None,
                   merge_end_coord:tuple=None,
                   header_row:bool=False,
                   header_column:bool=False,
                   block_id:str=None, access_token=None) -> list:
        '''
        创建docx普通表格
        :param merge coord:
            合并坐标从下标1开始，比如第2行第2列到第3行第4列，start:(2, 2) end:(3, 4)
        :return:
            table_block_id, childrenblocks
        '''
        if row < 1 or col < 1:
            return None
        if not block_id:
            block_id = document_id
        url = self._host + f'/open-apis/docx/v1/documents/{document_id}/blocks/{block_id}/children'
        access_token = self.token if not access_token else access_token
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + access_token}
        extra_row = 0 if row < 10 else (row - 9)
        extra_col = 0 if col < 10 else (col - 9)
        payload = {
            "index": -1,
            "children": [
                {
                    "block_type": 31,
                    "table": {
                        "property": {
                            "row_size": 9 if extra_row else row,
                            "column_size": 9 if extra_col else col,
                            "column_width": column_width,
                            "header_row":header_row,
                            "header_column":header_column,
                        }
                    }
                }
            ]
        }
        resp = request("POST", url, headers, payload)
        childrenblocks = []
        if resp['code'] == 0:
            childrenblocks = [c for c in resp['data']['children'][0]['children']]
        table_id = resp['data']['children'][0]['block_id']

        url = self._host + f'/open-apis/docx/v1/documents/{document_id}/blocks/{table_id}'
        while extra_row:
            payload = {
                'insert_table_row':{
                    "row_index": -1,
                },
            }
            request("PATCH", url, headers, payload)
            extra_row -= 1
            # 接口频率限制 3次/秒
            time.sleep(0.34)

        while extra_col:
            payload = {
                'insert_table_column':{
                    "column_index": -1,
                },
            }
            request("PATCH", url, headers, payload)
            extra_col -= 1
            # 接口频率限制 3次/秒
            time.sleep(0.34)

        if not merge_start_coord or not merge_end_coord:
            return table_id, childrenblocks
        payload = {
            'merge_table_cells':{
                "row_start_index":merge_start_coord[0]-1,
                "row_end_index":merge_end_coord[0],
                "column_start_index":merge_start_coord[1]-1,
                "column_end_index":merge_end_coord[1],
            }
        }
        request("PATCH", url, headers, payload)

        return table_id, childrenblocks
    
    def merge_table_cell(self, document_id, table_id, merge_start_coord, merge_end_coord, access_token=None):
        url = self._host + f'/open-apis/docx/v1/documents/{document_id}/blocks/{table_id}'
        access_token = self.token if not access_token else access_token
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + access_token}
        payload = {
            'merge_table_cells':{
                "row_start_index":merge_start_coord[0]-1,
                "row_end_index":merge_end_coord[0],
                "column_start_index":merge_start_coord[1]-1,
                "column_end_index":merge_end_coord[1],
            }
        }
        request("PATCH", url, headers, payload)
    
    def updateblocktext(self, document_id:str, block_id:str, block:block, access_token=None):
        '''
        更新块文本
        '''
        url = self._host + f'/open-apis/docx/v1/documents/{document_id}/blocks/{block_id}'
        access_token = self.token if not access_token else access_token
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + access_token}
        payload = {
            'update_text' if block.content != None else 'update_text_style':{
                "style":{
                    "indentation_level": block.indent,
                    "align":block.align,
                    "background_color":block.background_color,
                },
                "elements": [
                    {
                        "text_run": {
                            "content": content,
                            "text_element_style": style
                        },
                    }
                    for content, style in block.content
                ] if block.content != None else None,
                "fields":[1, 7] + ([6] if block.background_color else []),
            },
        }
        request("PATCH", url, headers, payload)
        # 限制api请求频率
        time.sleep(0.1)
        return
    
    def createcallout(self, document_id:str, background_color=2, border_color=2, text_color=None, emoji='bust_in_silhouette', block_id:str=None, insert_index:int=-1, access_token=None) -> list:
        '''
        创建高亮块
        return:
            blockid, child_id
        
        background_color:
            1：浅红色
            2：浅橙色
            3：浅黄色
            4：浅绿色
            5：浅蓝色
            6：浅紫色
            7：中灰色
            8：中红色
            9：中橙色
            10：中黄色
            11：中绿色
            12：中蓝色
            13：中紫色
            14：灰色
            15：浅灰色

        border_color/test_color:
            1：红色
            2：橙色
            3：黄色
            4：绿色
            5：蓝色
            6：紫色
            7：灰色

        高亮块emoji参考：https://open.feishu.cn/document/docs/docs/data-structure/emoji
        '''
        if not block_id:
            block_id = document_id
        url = self._host + f'/open-apis/docx/v1/documents/{document_id}/blocks/{block_id}/children'
        access_token = self.token if not access_token else access_token
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + access_token}
        payload = {
            "index": insert_index,
            "children": [
                {
                    "block_type": 19,
                    'callout': {
                        "background_color": background_color, 
                        "border_color": border_color,
                        "text_color": text_color,
                        'emoji_id':emoji,
                    }
                }
            ]
        }
        resp = request("POST", url, headers, payload)
        bid, cid = resp['data']['children'][0]['block_id'], resp['data']['children'][0]['children'][0]
        # 限制api请求频率
        time.sleep(0.1)
        return bid, cid
    

    def updateblockimage(self, document_id:str, block_id:str, image_token=None, img_property:dict={}, access_token=None):
        '''
        img_property:
            width:
                图片宽度，单位像素（px）
            height:
                图片高度，单位像素（px）
            align:
                对齐方式
                可选值有：
                1：居左排版
                2：居中排版
                3：居右排版
        '''
        url = self._host + f'/open-apis/docx/v1/documents/{document_id}/blocks/{block_id}'
        access_token = self.token if not access_token else access_token
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + access_token}
        payload = {
            'replace_image':{
                "token":image_token,
                "width":img_property.get('width', None),
                "height":img_property.get('height', None),
                "align":img_property.get('align', None),
            }
        }
        resp = request("PATCH", url, headers, payload)
        # 限制接口频率
        time.sleep(0.34)
        return resp

    def add_permissions(self, document_id, member_id, permission='full_access', member_type='openchat', notify=False, check=True, access_token=None):
        '''
        member_id:
            协作者 ID，与协作者 ID 类型需要对应
        memeber_type:
            email：飞书邮箱
            openid：开放平台 ID
            unionid：开放平台 UnionID
            openchat：开放平台群组 ID
            opendepartmentid：开放平台部门 ID。仅当使用 user_access_token 调用时有效
            userid：用户自定义 ID
            groupid：自定义用户组 ID
            wikispaceid：知识空间 ID
        permission:
            view：可阅读角色
            edit：可编辑角色
            full_access：可管理角色
        '''
        url = self._host + f'/open-apis/drive/v1/permissions/{document_id}/members?need_notification={notify}&type=docx'
        access_token = self.token if not access_token else access_token
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + access_token}
        tmap = {"email":"user", "openchat":"chat"}
        payload = {
            "member_id": member_id,
            "member_type": member_type,
            "perm": permission,
            "perm_type": "container",
            "type": tmap.get(member_type, 'user'),
        }
        resp = None
        try:
            resp = request("POST", url, headers, payload)
        except Exception as e:
            if check:raise Exception(e)
            else:print(e)
        return resp

    def upload_image(self, block_id, file_path, access_token=None):
        file_path = os.path.abspath(file_path)
        file_size = os.path.getsize(file_path)
        url = self._host + f"open-apis/drive/v1/medias/upload_all"
        form = {
            'file_name': os.path.basename(file_path),
            'parent_type': 'docx_image',
            'parent_node': block_id,
            'size': str(file_size),
            'file': (open(file_path, 'rb'))
        }  
        multi_form = MultipartEncoder(form)
        access_token = self.token if not access_token else access_token
        headers = {'Content-Type': multi_form.content_type, 'Authorization': 'Bearer ' + access_token}
        response = requests.request("POST", url, headers=headers, data=multi_form)
        resp = {}
        if bool(response.text) and response.text[0] == '{':
            resp = response.json()
        else:
            pass
        code = resp.get("code", -1)
        if code == -1:
            code = resp.get("StatusCode", -1)
        if code == -1 and response.status_code != 200:
            response.raise_for_status()
        if code != 0:
            raise LarkException(code=code, msg=resp.get("msg", ""))
        token = None
        if resp['code'] == 0:
            token = resp['data']['file_token']
        # 限制接口频率
        time.sleep(0.34)
        return token
    
    def delete_children_blocks(self, document_id, index_range, block_id=None, access_token=None):
        '''
        :param index_range:
            删除的索引，下标从1开始，支持 Int | List
            示例:
                删除子块序列1到3
                index_range=[1, 3]
                删除子块1
                index_range=1
        '''
        if not block_id:
            block_id = document_id
        if not isinstance(index_range, Iterable):
            index_range = [index_range] * 2
        if any([index <= 0 for index in index_range]):
            raise ValueError('下标从1开始')
        url = self._host + f'open-apis/docx/v1/documents/{document_id}/blocks/{block_id}/children/batch_delete'
        access_token = self.token if not access_token else access_token
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + access_token}
        payload = {
            'start_index':min(index_range)-1,
            'end_index':max(index_range),
        }
        resp = request("DELETE", url, headers, payload)
        # 限制接口频率
        time.sleep(0.34)
        return resp

    def insert_image(self, document_id, image_path, block_id=None, replace=False):
        if not os.path.exists(image_path):
            print('image path not exists!')
            return
        img_block_id = self.createblocks(document_id, block(None, 27), block_id=block_id)[-1]
        if replace:
            self.delete_children_blocks(document_id, 1, block_id)
        image_token = self.upload_image(img_block_id, image_path)
        return self.updateblockimage(document_id, img_block_id, image_token)
    
    ############################### SHEET API ######################################

    def update_permission(self, file_token, file_type="sheet"):
        url = self._host + f"/open-apis/drive/v1/permissions/{file_token}/public?type={file_type}"
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + self.token}
        payload = {"link_share_entity": "tenant_editable"}
        resp = request("PATCH", url, headers, payload)
        return resp['data']

    def find_cell(self, spreadsheet_token, sheet_id, find_str):
        url = self._host + f"/open-apis/sheets/v3/spreadsheets/{spreadsheet_token}/sheets/{sheet_id}/find"
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + self.token}
        payload = {"find_condition": {"range": sheet_id + "!A:E", "match_case": False, "match_entire_cell": False,
                                      "search_by_regex": False, "include_formulas": False}, "find": find_str}
        resp = request("POST", url, headers, payload)
        return resp['data']

    def get_values_batch(self, spreadsheet_token, ranges, value_render="Formula"):
        url = self._host + f"/open-apis/sheets/v2/spreadsheets/{spreadsheet_token}/values_batch_get?" f"ranges={ranges}&valueRenderOption={value_render}"
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + self.token}
        payload = {"ranges": ranges, "valueRenderOption": "Formula"}
        resp = request("GET", url, headers, payload)
        return resp['data']

    def update_values(self, spreadsheet_token, crange, values):
        url = self._host + f"/open-apis/sheets/v2/spreadsheets/{spreadsheet_token}/values"
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + self.token}
        payload = {"valueRange": {"range": crange, "values": values}}
        resp = request("PUT", url, headers, payload)
        return resp['data']

    def set_cell_style(self, spreadsheet_token, crange, foreColor=None, backColor=None):
        url = self._host + f"/open-apis/sheets/v2/spreadsheets/{spreadsheet_token}/style"
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + self.token}
        style = {"formatter": "@", "vAlign": 1, "hAlign": 1, "foreColor": foreColor, "backColor": backColor}
        payload = {"appendStyle": {"range": crange, "style": style}}
        resp = request("PUT", url, headers, payload)
        return resp['data']
    
    def batch_set_cell_style(self, spreadsheet_token, styles):
        """
        批量设置单元格样式，样式字典参考：https://open.feishu.cn/document/server-docs/docs/sheets-v3/data-operation/batch-set-cell-style#1b8abd5d
        """
        url = self._host + f"/open-apis/sheets/v2/spreadsheets/{spreadsheet_token}/styles_batch_update"
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + self.token}
        resp = request("PUT", url, headers, {"data": styles})
        return resp['data']

    def insert_cell_image(self, spreadsheet_token, image_data):
        url = self._host + "/open-apis/sheets/v2/spreadsheets/%s/values_image" % spreadsheet_token
        headers = {'Authorization': 'Bearer ' + self.token}
        payload = {"range": image_data[0], "image": image_data[1], "name": image_data[2]}
        resp = request("POST", url, headers, payload)
        return resp['data']

    def merge_cells(self, spreadsheet_token, crange):
        url = self._host + "/open-apis/sheets/v2/spreadsheets/%s/merge_cells" % spreadsheet_token
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + self.token}
        payload = {"range": crange, "mergeType": "MERGE_ALL"}
        resp = request("POST", url, headers, payload)
        return resp['data']

    def create_spreadsheet(self, foldertoken, title):
        url = self._host + "/open-apis/sheets/v3/spreadsheets"
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + self.token}
        payload = {"title": title, "folder_token": foldertoken}
        resp = request("POST", url, headers, payload)
        return resp['data']['spreadsheet']['spreadsheet_token'], resp['data']['spreadsheet']['url']

    def get_first_sheetid(self, spreadsheet_token):
        url = self._host + "/open-apis/sheets/v2/spreadsheets/" + spreadsheet_token + "/metainfo"
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + self.token}
        resp = request("GET", url, headers)
        return resp['data']['sheets'][0]["sheetId"]

    def get_sheets_info(self, spreadsheet_token):
        url = self._host + "/open-apis/sheets/v2/spreadsheets/" + spreadsheet_token + "/metainfo"
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + self.token}
        resp = request("GET", url, headers)
        return resp['data']['sheets']
    
    def set_dimension_properties(self, spreadsheet_token, dimension_set):
        url = self._host + "/open-apis/sheets/v2/spreadsheets/" + spreadsheet_token + "/dimension_range"
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + self.token}
        payload = {
            "dimension":{
                "sheetId":dimension_set['sheetId'],
                "majorDimension":dimension_set['majorDimension'],
                "startIndex":dimension_set['startIndex'],
                "endIndex":dimension_set['endIndex']
            },
            "dimensionProperties":{
                "visible":'true',
                "fixedSize":dimension_set['fixedSize']
            }
        }
        resp = request("PUT", url, headers, payload)
        return resp['data']

    def sheets_batch_update(self, spreadsheet_token, sheetid):
        url = self._host + "/open-apis/sheets/v2/spreadsheets/%s/sheets_batch_update" % spreadsheet_token
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + self.token}
        payload = {"requests": [
            {"updateSheet": {"properties": {"sheetId": sheetid, "frozenColCount": 0, "frozenRowCount": 1}}}]}
        resp = request("POST", url, headers, payload)
        return resp['data']

    def media_download_image(self, file_token):
        url = self._host + f"/open-apis/drive/v1/medias/{file_token}/download"
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + self.token}
        response = requests.get(url, headers=headers, timeout=10)
        response.raise_for_status()
        cl = response.content
        return cl

    def upload_file_to_drive(self, file_path, parent_node=None, file_name=None):
        prepare_url = self._host + f"/open-apis/drive/v1/files/upload_prepare"
        part_url = self._host + f"/open-apis/drive/v1/files/upload_part"
        finish_url = self._host + f"/open-apis/drive/v1/files/upload_finish"
        if file_name is None:
            file_name = os.path.basename(file_path)
        part_size = 4194304
        if parent_node is None:
            parent_node = 'XKh7fHoDYlFprOdkcEQcgAuHnLh'

        def cal_file_block(local_path):
            result = []
            with open(local_path, 'rb') as f:
                index = 0
                while True:
                    chunk = f.read(part_size)
                    if not chunk:
                        break
                    result.append(chunk)
                    index += 1
            return result

        file_stat = os.stat(file_path)
        payload = {'file_name': file_name, 'parent_type': 'explorer', 'parent_node': parent_node,
                   'size': str(file_stat.st_size)}
        headers = {'Authorization': 'Bearer ' + self.token}
        result = request("POST", prepare_url, headers=headers, data=payload)
        upload_id = result['data']['upload_id']
        block_num = result['data']['block_num']
        block_size = result['data']['block_size']
        blocks = cal_file_block(file_path)
        for index, block in enumerate(blocks):
            payload = {'upload_id': upload_id, 'seq': str(index), 'size': str(len(block)), 'file': block}
            multi_form = MultipartEncoder(payload)
            part_headers = headers.copy()
            part_headers['Content-Type'] = multi_form.content_type
            response = request("POST", part_url, part_headers, data=multi_form)
        finish_payload = {'upload_id': upload_id, 'block_num': block_num}
        response = request("POST", finish_url, headers, data=finish_payload)
        return response['data']

    def add_work_sheet(self, spreadsheet_token, title, index=0):
        url = self._host + f"/open-apis/sheets/v2/spreadsheets/{spreadsheet_token}/sheets_batch_update"
        headers = {'Content-Type': 'application/json; charset=utf-8', 'Authorization': 'Bearer ' + self.token}
        payload = {"requests": [{"addSheet": {"properties": {"title": title, "index": index}}}]}
        resp = request("POST", url, headers, payload)
        return resp['data']
    


    def create_numbered_headings(self, document_id: str, titles: list, 
                                heading_level: int = 1, parent_block_id: str = None,
                                bold: bool = True, access_token = None):
        '''
        插入带编号的标题块（支持heading1/heading2，自动显示在导航栏）
        :param document_id: 文档ID
        :param titles: 标题列表，如['第一章 概述', ...]
        :param heading_level: 标题级别，1表示heading1，2表示heading2
        :param parent_block_id: 父块ID（不传为根节点）
        :param bold: 是否加粗
        :param access_token: 访问令牌
        :return: 插入的block节点列表
        '''
        # 验证标题级别
        if heading_level not in [1, 2, 3, 4, 5]:
            raise ValueError("heading_level must be 1、2、3、4、5")
        
        host = self._host
        access_token = self.token if not access_token else access_token
        parent_block_id = parent_block_id or document_id  # 根节点默认为文档ID
        url = f"{host}/open-apis/docx/v1/documents/{document_id}/blocks/{parent_block_id}/children"
        headers = {
            "Content-Type": "application/json; charset=utf-8",
            "Authorization": f"Bearer {access_token}"
        }
        
        children = []
        for idx, title in enumerate(titles, 1):
            # 根据标题级别设置block_type和对应字段
            block_type = 3 if heading_level == 1 else 4
            heading_field = "heading1" if heading_level == 1 else "heading2"
            
            children.append({
                "block_type": block_type,
                heading_field: {
                    "elements": [
                        {
                            "text_run": {
                                "content": f"{idx}. {title}",
                                "text_element_style": {
                                    "bold": bold
                                }
                            }
                        }
                    ]
                }
            })
        
        payload = {
            "index": -1,
            "children": children
        }
        
        resp = request("POST", url, headers, payload)
        return resp['data']['children']

def get_table_grids_wp(cli:Client, docid):
    def func(tableid):
        return [c['children'][0] for c in cli.fetchblocks(docid, tableid)['data']['items']]
    return func
```